apiVersion: batch/v1
kind: Job
metadata:
  name: {{ submission.job_name }}
  labels:
    id: "{{ submission.id }}"
    task: "{{ submission.task.name }}"
    phase: "{{ submission.phase.name }}"
    team: "{{ submission.team.username }}"
spec:
  template:
    metadata:
      labels:
        id: "{{ submission.id }}"
        task: "{{ submission.task.name }}"
        phase: "{{ submission.phase.name }}"
        team: "{{ submission.team.username }}"
    spec:
      initContainers:
      - name: decode
        image: "gcr.io/clic-215616/decoding:latest"
        imagePullPolicy: Always
        {% if submission.docker_image.gpu %}
        resources:
          limits:
            nvidia.com/gpu: 1
        {% endif %}
        command: [
          "python3",
          "/code/decode.py",
          "--debug",
          "--auth_token", "{{ submission.auth_token }}",
          "--submission_bucket", "clic2020_submissions",
          "--submission_path", "{{ submission.fs_path }}",
          "--environment_bucket", "clic2020_environments",
          "--exec_dir", "/var/lib/docker/submissions",
          "--num_cpus", "1",
          "--memory_limit", "12g",
          "--timeout", "36000",
          "--task", "{{ submission.task.name }}",
          "--phase", "{{ submission.phase.name }}",
          "--team", "{{ submission.team.username }}",
          "--image", "{{ submission.docker_image.name }}"{% if submission.docker_image.gpu %},
          "--gpu"{% endif %}]
        securityContext:
          capabilities: {}
          privileged: true
        env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: "/var/run/secret/cloud.google.com/service-account.json"
        volumeMounts:
          - name: clic-sa-key-volume
            mountPath: "/var/run/secret/cloud.google.com"
          - name: docker-sock
            mountPath: "/var/run/docker.sock"
          - name: executable-volume
            mountPath: "/var/lib/docker"
          - name: code-volume
            mountPath: "/code"
      containers:
      - name: evaluate
        image: "gcr.io/clic-215616/evaluation"
        command: [
          "python3",
          "/code/evaluate.py",
          "--debug",
          "--auth_token", "{{ submission.auth_token }}",
          "--submission_bucket", "clic2020_submissions",
          "--submission_path", "{{ submission.fs_path }}",
          "--target_bucket", "clic2020_targets",
          "--task", "{{ submission.task.name }}",
          "--phase", "{{ submission.phase.name }}",
          "--team", "{{ submission.team.name }}",
          "--metrics", "PSNR", "MSSSIM"]
        securityContext:
          capabilities: {}
          privileged: true
        env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: "/var/run/secret/cloud.google.com/service-account.json"
        volumeMounts:
          - name: clic-sa-key-volume
            mountPath: "/var/run/secret/cloud.google.com"
          - name: code-volume
            mountPath: "/code"
      restartPolicy: Never
      volumes:
        - name: clic-sa-key-volume
          secret:
            secretName: clic-sa-key
        - name: docker-sock
          hostPath:
            path: "/var/run/docker.sock"
        - name: executable-volume
          hostPath:
            path: "/var/lib/docker"
        - name: code-volume
          configMap:
            name: code
  backoffLimit: 0
